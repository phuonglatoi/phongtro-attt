# üîê T·ªîNG H·ª¢P C√ÅC LO·∫†I B·∫¢O M·∫¨T TRONG H·ªÜ TH·ªêNG

---

## üìä PH·∫¶N 1: B·∫¢O M·∫¨T C∆† S·ªû D·ªÆ LI·ªÜU (SQL Server)

### 1.1 Always Encrypted (M√£ h√≥a c·ªôt)

| C·ªôt ƒë∆∞·ª£c m√£ h√≥a | B·∫£ng | Lo·∫°i m√£ h√≥a |
|-----------------|------|-------------|
| `CCCD` | KHACHHANG | Deterministic |
| `SDT` | KHACHHANG | Randomized |
| `PASSWORD_HASH` | TAIKHOAN | Binary |

**üìç V·ªã tr√≠ c·∫•u h√¨nh:**
```
config/settings/development.py - D√≤ng 47
full_extra_params = base_params + 'ColumnEncryption=Enabled;'
```

---

### 1.2 Transparent Data Encryption (TDE)

> M√£ h√≥a to√†n b·ªô file database (.mdf, .ldf) tr√™n ·ªï ƒëƒ©a

**üìç V·ªã tr√≠:** SQL Server Management Studio
```sql
ALTER DATABASE QuanLyChoThuePhongTro SET ENCRYPTION ON;
```

---

### 1.3 Dynamic Data Masking

| C·ªôt | Ki·ªÉu masking | K·∫øt qu·∫£ |
|-----|--------------|---------|
| `SDT` | partial(4,"***",3) | 0901***234 |
| `EMAIL` | email() | n***@gmail.com |
| `CCCD` | default() | xxxx |

**üìç V·ªã tr√≠:** SQL Server (ch·∫°y script trong SSMS)
```sql
ALTER TABLE KHACHHANG ALTER COLUMN SDT ADD MASKED WITH (FUNCTION = 'partial(4,"***",3)');
ALTER TABLE KHACHHANG ALTER COLUMN EMAIL ADD MASKED WITH (FUNCTION = 'email()');
```

---

### 1.4 Row-Level Security (RLS)

> Ch·ªß tr·ªç ch·ªâ xem ƒë∆∞·ª£c ph√≤ng c·ªßa m√¨nh

**üìç V·ªã tr√≠:** SQL Server (ch·∫°y script trong SSMS)
```sql
CREATE FUNCTION dbo.fn_PhongTroFilter(@MACT INT)
RETURNS TABLE WITH SCHEMABINDING
AS RETURN SELECT 1 AS result WHERE @MACT = CAST(SESSION_CONTEXT(N'MACT') AS INT);

CREATE SECURITY POLICY PhongTroFilter
ADD FILTER PREDICATE dbo.fn_PhongTroFilter(MACT) ON dbo.PHONGTRO;
```

---

### 1.5 Stored Procedures (Ch·ªëng SQL Injection)

**üìç V·ªã tr√≠:** SQL Server
```sql
CREATE PROCEDURE SP_SECURE_LOGIN
    @Email NVARCHAR(100),
    @PasswordHash VARBINARY(64)
AS BEGIN
    SELECT * FROM TAIKHOAN WHERE USERNAME = @Email AND PASSWORD_HASH = @PasswordHash;
END
```

---

### 1.6 Audit Triggers

**üìç V·ªã tr√≠:** SQL Server
```sql
CREATE TRIGGER TRG_AUDIT_TAIKHOAN ON TAIKHOAN
AFTER UPDATE, DELETE AS BEGIN
    INSERT INTO AUDIT_LOGS (TABLE_NAME, ACTION, OLD_DATA, NEW_DATA, CHANGED_DATE)
    SELECT 'TAIKHOAN', 'UPDATE', 
           (SELECT * FROM deleted FOR JSON PATH),
           (SELECT * FROM inserted FOR JSON PATH),
           GETDATE();
END
```

---

### 1.7 Backup Database

**üìç V·ªã tr√≠:**
| File | M√¥ t·∫£ |
|------|-------|
| `scripts/backup_database.py` | Script backup t·ª± ƒë·ªông |
| `config/celery.py` d√≤ng 16-20 | Scheduled backup 2:00 AM |
| `backups/` | Th∆∞ m·ª•c l∆∞u file .bak |

---

### 1.8 ‚ö° GI·ªöI H·∫†N T√ÄI NGUY√äN (Resource Governor)

#### A. C·∫•u h√¨nh trong Django (Application Level)

| Gi·ªõi h·∫°n | Gi√° tr·ªã | V·ªã tr√≠ |
|----------|---------|--------|
| **Connection Pool** | 60 gi√¢y | `config/settings/production.py` d√≤ng 31: `CONN_MAX_AGE = 60` |
| **Session Timeout** | 15 ph√∫t | `config/settings/security.py` d√≤ng 51: `SESSION_COOKIE_AGE = 900` |
| **Max Concurrent Sessions** | 3 thi·∫øt b·ªã | `config/settings/security.py` d√≤ng 243: `MAX_CONCURRENT_SESSIONS = 3` |
| **Redis Socket Timeout** | 5 gi√¢y | `config/settings/production.py` d√≤ng 44-45 |

#### B. Rate Limiting (Gi·ªõi h·∫°n s·ªë request/ph√∫t)

**üìç V·ªã tr√≠:** `config/settings/security.py` d√≤ng 173-184

| H√†nh ƒë·ªông | Gi·ªõi h·∫°n | C·∫•u h√¨nh |
|-----------|----------|----------|
| Login | 5 l·∫ßn/ph√∫t | `RATELIMIT_LOGIN = '5/m'` |
| Register | 3 l·∫ßn/10 ph√∫t | `RATELIMIT_REGISTER = '3/10m'` |
| API Request | 60 l·∫ßn/ph√∫t | `RATELIMIT_API = '60/m'` |
| Upload File | 10 file/gi·ªù | `RATELIMIT_UPLOAD = '10/h'` |
| Comment | 10 l·∫ßn/gi·ªù | `RATELIMIT_COMMENT = '10/h'` |
| Report | 5 l·∫ßn/ng√†y | `RATELIMIT_REPORT = '5/d'` |

#### C. Auto-Block IP (T·ª± ƒë·ªông ch·∫∑n IP vi ph·∫°m)

**üìç V·ªã tr√≠:** `config/settings/security.py` d√≤ng 211-216

```python
AUTO_BLOCK_IP_CONDITIONS = {
    'failed_logins': 10,         # 10 l·∫ßn login sai ‚Üí Block
    'spam_posts': 20,            # 20 b√†i ƒëƒÉng/gi·ªù ‚Üí Block
    'suspicious_requests': 100,  # 100 request b·∫•t th∆∞·ªùng/ph√∫t ‚Üí Block
}
```

#### D. C·∫•u h√¨nh SQL Server (Database Level)

**üìç V·ªã tr√≠:** Ch·∫°y trong SQL Server Management Studio (SSMS)

```sql
-- 1. Gi·ªõi h·∫°n th·ªùi gian query (Query Timeout)
-- Ng·∫Øt k·∫øt n·ªëi query ch·∫°y qu√° 30 gi√¢y
EXEC sp_configure 'remote query timeout', 30;
RECONFIGURE;

-- 2. Gi·ªõi h·∫°n s·ªë k·∫øt n·ªëi ƒë·ªìng th·ªùi
-- T·ªëi ƒëa 100 connections (0 = unlimited)
EXEC sp_configure 'user connections', 100;
RECONFIGURE;

-- 3. Gi·ªõi h·∫°n b·ªô nh·ªõ SQL Server s·ª≠ d·ª•ng
-- T·ªëi ƒëa 4GB RAM (t√≠nh b·∫±ng MB)
EXEC sp_configure 'max server memory', 4096;
RECONFIGURE;

-- 4. Resource Governor - T·∫°o pool gi·ªõi h·∫°n CPU v√† Memory
CREATE RESOURCE POOL LimitedPool
WITH (
    MAX_CPU_PERCENT = 50,        -- T·ªëi ƒëa 50% CPU
    MAX_MEMORY_PERCENT = 30      -- T·ªëi ƒëa 30% Memory
);

CREATE WORKLOAD GROUP WebAppGroup
USING LimitedPool;

-- 5. Ki·ªÉm tra c·∫•u h√¨nh
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure;
```

#### E. B·∫£ng t·ªïng h·ª£p gi·ªõi h·∫°n t√†i nguy√™n

| Lo·∫°i gi·ªõi h·∫°n | M·ª©c | Gi√° tr·ªã | V·ªã tr√≠ |
|---------------|-----|---------|--------|
| **S·ªë c√¢u truy v·∫•n/ph√∫t** | App | 60 req/ph√∫t | `security.py` - Rate Limit |
| **Timeout query l·ªõn** | DB | 30 gi√¢y | SQL Server `sp_configure` |
| **Ng∆∞·ª°ng CPU** | DB | 70% | SQL Server Resource Governor |
| **Ng∆∞·ª°ng Memory** | DB | 50% ho·∫∑c 4GB | SQL Server `sp_configure` |
| **S·ªë user CSDL ƒë·ªìng th·ªùi** | DB | 100 connections | SQL Server `sp_configure` |
| **Session timeout** | App | 15 ph√∫t | `security.py` d√≤ng 51 |
| **Max thi·∫øt b·ªã ƒëƒÉng nh·∫≠p** | App | 3 thi·∫øt b·ªã | `security.py` d√≤ng 243 |
| **Max request ƒë·ªìng th·ªùi/group** | DB | 50 requests | Resource Governor |
| **Max CPU time/query** | DB | 30 gi√¢y | Resource Governor |

#### üìÅ Script t·ª± ƒë·ªông c·∫•u h√¨nh

**üìç V·ªã tr√≠:** `scripts/sql/resource_governor.sql`

```
C√°ch ch·∫°y:
1. M·ªü SQL Server Management Studio (SSMS)
2. K·∫øt n·ªëi v·ªõi quy·ªÅn sysadmin
3. M·ªü file scripts/sql/resource_governor.sql
4. Nh·∫•n F5 ƒë·ªÉ ch·∫°y to√†n b·ªô script
```

---

## üìä PH·∫¶N 2: B·∫¢O M·∫¨T H·ªÜ TH·ªêNG (Django)

---

### üî∑ NH√ìM 1: `config/settings/security.py`

| D√≤ng | T√≠nh nƒÉng | M√¥ t·∫£ |
|------|-----------|-------|
| 18-24 | **Password Hashers** | Argon2, PBKDF2 |
| 27-75 | **HTTPS/HSTS** | SECURE_SSL_REDIRECT, HSTS |
| 77-110 | **CSP Headers** | Content-Security-Policy |
| 120-145 | **Session Security** | HttpOnly, Secure, SameSite |
| 160-170 | **reCAPTCHA** | RECAPTCHA_PUBLIC_KEY, SECRET_KEY |
| 172-184 | **Rate Limiting** | RATELIMIT_LOGIN = '5/m' |
| 186-196 | **Account Lockout** | MAX_LOGIN_ATTEMPTS = 5 |
| 218-222 | **IP Whitelist/Blacklist** | IP_WHITELIST, IP_BLACKLIST |
| 224-237 | **Audit Config** | AUDIT_LOG_ACTIONS |
| 240-244 | **Device Tracking** | MAX_CONCURRENT_SESSIONS = 3 |
| 273-297 | **WAF Patterns** | SQL Injection, XSS regex |

---

### üî∑ NH√ìM 2: `config/settings/base.py`

| D√≤ng | T√≠nh nƒÉng | M√¥ t·∫£ |
|------|-----------|-------|
| 20 | **ALLOWED_HOSTS** | Danh s√°ch domain ƒë∆∞·ª£c ph√©p |
| 23-28 | **CSRF_TRUSTED_ORIGINS** | Domain tin c·∫≠y cho CSRF |
| 95 | **CSRF Middleware** | django.middleware.csrf.CsrfViewMiddleware |
| 102-105 | **Custom Middleware** | IP Filter, WAF, Audit, Device Tracking |

---

### üî∑ NH√ìM 3: `apps/accounts/views.py`

| D√≤ng | T√≠nh nƒÉng | M√¥ t·∫£ |
|------|-----------|-------|
| 51-64 | **track_failed_login()** | Ghi log ƒëƒÉng nh·∫≠p th·∫•t b·∫°i |
| 72-91 | **check_login_throttling()** | Ki·ªÉm tra IP b·ªã kh√≥a |
| 170-184 | **verify_password()** | X√°c th·ª±c password v·ªõi salt |
| 187-190 | **hash_password()** | Hash SHA-256 + Salt |
| 197-427 | **login_view()** | Login + reCAPTCHA + Brute force |
| 429-465 | **login_2fa_view()** | X√°c th·ª±c OTP |
| 540-650 | **google_login/callback()** | OAuth 2.0 Google |
| 780-860 | **setup_2fa_view()** | T·∫°o QR code 2FA |
| 1055-1134 | **password_reset_view()** | Reset password qua email OTP |

---

### üî∑ NH√ìM 4: `apps/accounts/models.py`

| D√≤ng | Model | M√¥ t·∫£ |
|------|-------|-------|
| 26-45 | **Taikhoan** | password_hash, password_salt, is_locked |
| 60-90 | **Khachhang** | is_2fa_enabled, totp_secret |
| 101-146 | **2FA Methods** | enable_2fa(), verify_totp() |
| 164-186 | **LoginHistory** | IP, device, browser, location |
| 190-205 | **FailedLoginAttempts** | Theo d√µi ƒëƒÉng nh·∫≠p th·∫•t b·∫°i |
| 206-220 | **BlockedIps** | Danh s√°ch IP b·ªã ch·∫∑n |
| 223-240 | **SecurityLogs** | Log s·ª± ki·ªán b·∫£o m·∫≠t |
| 243-260 | **AuditLogs** | Log thay ƒë·ªïi d·ªØ li·ªáu |

---

### üî∑ NH√ìM 5: `apps/accounts/security.py`

| D√≤ng | H√†m | M√¥ t·∫£ |
|------|-----|-------|
| 15-25 | **get_client_ip()** | L·∫•y IP th·ª±c c·ªßa client |
| 28-40 | **check_ip_blocked()** | Ki·ªÉm tra IP c√≥ b·ªã ch·∫∑n |
| 44-73 | **log_failed_login()** | Ghi log + auto-block IP |
| 76-86 | **log_security_event()** | Ghi log s·ª± ki·ªán b·∫£o m·∫≠t |
| 89-93 | **lock_account()** | Kh√≥a t√†i kho·∫£n |
| 104-114 | **check_account_locked()** | Ki·ªÉm tra t√†i kho·∫£n b·ªã kh√≥a |
| 117-128 | **increment_failed_login()** | TƒÉng ƒë·∫øm th·∫•t b·∫°i |
| 131-134 | **reset_failed_login()** | Reset ƒë·∫øm sau login th√†nh c√¥ng |

---

### üî∑ NH√ìM 6: `apps/security/middleware/` (Th∆∞ m·ª•c Middleware)

| File | Class | M√¥ t·∫£ |
|------|-------|-------|
| `ip_filter.py` | **IPFilterMiddleware** | Ch·∫∑n IP trong blacklist |
| `waf.py` | **WAFMiddleware** | Ch·∫∑n SQL Injection, XSS, Path Traversal |
| `audit.py` | **AuditMiddleware** | Ghi log c√°c request quan tr·ªçng |
| `device_tracking.py` | **DeviceTrackingMiddleware** | Theo d√µi thi·∫øt b·ªã ƒëƒÉng nh·∫≠p |

---

### üî∑ NH√ìM 7: Templates (CSRF Token)

| File | T√≠nh nƒÉng |
|------|-----------|
| `templates/accounts/login.html` | `{% csrf_token %}`, reCAPTCHA widget |
| `templates/accounts/register.html` | `{% csrf_token %}` |
| `templates/**/*.html` | T·∫•t c·∫£ form ƒë·ªÅu c√≥ `{% csrf_token %}` |

---

## üìä PH·∫¶N 3: B·∫¢NG T·ªîNG H·ª¢P NHANH

### üóÑÔ∏è B·∫¢O M·∫¨T DATABASE

| # | Lo·∫°i b·∫£o m·∫≠t | V·ªã tr√≠ |
|---|--------------|--------|
| 1 | Always Encrypted | `config/settings/development.py` d√≤ng 47 |
| 2 | TDE | SQL Server (SSMS) |
| 3 | Dynamic Data Masking | SQL Server (SSMS) |
| 4 | Row-Level Security | SQL Server (SSMS) |
| 5 | Stored Procedures | SQL Server (SSMS) |
| 6 | Audit Triggers | SQL Server (SSMS) |
| 7 | Backup | `scripts/backup_database.py` |

### üñ•Ô∏è B·∫¢O M·∫¨T H·ªÜ TH·ªêNG

| # | Lo·∫°i b·∫£o m·∫≠t | V·ªã tr√≠ ch√≠nh |
|---|--------------|--------------|
| 1 | Password Hashing (SHA-256 + Salt) | `apps/accounts/views.py` d√≤ng 170-190 |
| 2 | 2FA (TOTP) | `apps/accounts/models.py` d√≤ng 101-146 |
| 3 | OAuth 2.0 (Google) | `apps/accounts/views.py` d√≤ng 540-650 |
| 4 | reCAPTCHA | `config/settings/security.py` d√≤ng 160-170 |
| 5 | CSRF Protection | `config/settings/base.py` d√≤ng 95 |
| 6 | WAF | `apps/security/middleware/waf.py` |
| 7 | Rate Limiting | `config/settings/security.py` d√≤ng 172-184 |
| 8 | Brute Force Protection | `apps/accounts/views.py` d√≤ng 51-91 |
| 9 | IP Blocking | `apps/security/middleware/ip_filter.py` |
| 10 | Session Security | `config/settings/security.py` d√≤ng 120-145 |
| 11 | HTTPS/HSTS | `config/settings/security.py` d√≤ng 27-75 |
| 12 | CSP Headers | `config/settings/security.py` d√≤ng 77-110 |
| 13 | Audit Logging | `apps/security/middleware/audit.py` |
| 14 | Device Tracking | `apps/security/middleware/device_tracking.py` |
| 15 | Login History | `apps/accounts/models.py` d√≤ng 164-186 |

---

## üìÇ S∆† ƒê·ªí C·∫§U TR√öC FILE B·∫¢O M·∫¨T

```
PhongTroATTT/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ settings/
‚îÇ       ‚îú‚îÄ‚îÄ base.py              ‚Üê CSRF, Middleware, ALLOWED_HOSTS
‚îÇ       ‚îú‚îÄ‚îÄ security.py          ‚Üê T·∫§T C·∫¢ C·∫§U H√åNH B·∫¢O M·∫¨T
‚îÇ       ‚îî‚îÄ‚îÄ development.py       ‚Üê Always Encrypted connection
‚îÇ
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ accounts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views.py             ‚Üê Login, 2FA, OAuth, Password Hash
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py            ‚Üê Models b·∫£o m·∫≠t (LoginHistory, BlockedIps...)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security.py          ‚Üê Helper functions (hash, verify, lock)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ security/
‚îÇ       ‚îî‚îÄ‚îÄ middleware/
‚îÇ           ‚îú‚îÄ‚îÄ ip_filter.py     ‚Üê Ch·∫∑n IP
‚îÇ           ‚îú‚îÄ‚îÄ waf.py           ‚Üê Web Application Firewall
‚îÇ           ‚îú‚îÄ‚îÄ audit.py         ‚Üê Ghi log request
‚îÇ           ‚îî‚îÄ‚îÄ device_tracking.py ‚Üê Theo d√µi thi·∫øt b·ªã
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ backup_database.py       ‚Üê Backup t·ª± ƒë·ªông
‚îÇ
‚îî‚îÄ‚îÄ templates/
    ‚îî‚îÄ‚îÄ accounts/
        ‚îú‚îÄ‚îÄ login.html           ‚Üê CSRF token, reCAPTCHA
        ‚îî‚îÄ‚îÄ *.html               ‚Üê T·∫•t c·∫£ form c√≥ CSRF token
```

---

## ‚úÖ CHECKLIST B·∫¢O M·∫¨T

### Database (SQL Server)
- [x] Always Encrypted cho CCCD, SDT
- [x] Password hash l∆∞u d·∫°ng binary
- [ ] TDE (c·∫ßn b·∫≠t th·ªß c√¥ng)
- [ ] Dynamic Data Masking (c·∫ßn ch·∫°y script)
- [ ] Row-Level Security (c·∫ßn ch·∫°y script)
- [x] Audit Triggers
- [x] Backup script

### Application (Django)
- [x] Password Hashing (SHA-256 + Salt)
- [x] 2FA (TOTP v·ªõi Google Authenticator)
- [x] OAuth 2.0 (Google Sign-In)
- [x] reCAPTCHA (sau 3 l·∫ßn sai)
- [x] CSRF Protection
- [x] WAF Middleware
- [x] Rate Limiting
- [x] Brute Force Protection
- [x] IP Blocking
- [x] Session Security (HttpOnly, Secure, SameSite)
- [x] HTTPS/HSTS
- [x] CSP Headers
- [x] Audit Logging
- [x] Device Tracking
- [x] Login History

---

**T·ªïng c·ªông: 20+ t√≠nh nƒÉng b·∫£o m·∫≠t ƒë∆∞·ª£c tri·ªÉn khai!** üéâ

