# ============================================
# PhongTro.vn Docker Compose - Production
# ============================================
version: '3.8'

services:
  # ============================================
  # SQL Server Database
  # ============================================
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: phongtro_db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${DB_PASSWORD}
      - MSSQL_PID=Express
    # Don't expose port externally in production!
    # ports:
    #   - "1433:1433"
    expose:
      - "1433"
    volumes:
      - mssql_data:/var/opt/mssql
    networks:
      - phongtro_internal
    restart: unless-stopped
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "$${SA_PASSWORD}" -Q "SELECT 1"
      interval: 30s
      timeout: 10s
      retries: 5

  # ============================================
  # Redis Cache & Session
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: phongtro_redis
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    # Don't expose port externally!
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    networks:
      - phongtro_internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ============================================
  # Django Application
  # ============================================
  web:
    build:
      context: .
      target: production
    container_name: phongtro_web
    command: >
      gunicorn config.wsgi:application
      --bind 0.0.0.0:8000
      --workers 3
      --threads 2
      --worker-class gthread
      --access-logfile -
      --error-logfile -
      --capture-output
      --timeout 120
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
      - logs_volume:/app/logs
    expose:
      - "8000"
    env_file:
      - .env
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings.production
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - phongtro_internal
    restart: unless-stopped
    # Security: Read-only root filesystem (except volumes)
    read_only: true
    tmpfs:
      - /tmp

  # ============================================
  # Celery Worker (Background Tasks)
  # ============================================
  celery_worker:
    build:
      context: .
      target: production
    container_name: phongtro_celery
    command: celery -A config worker -l info --concurrency=2
    volumes:
      - media_volume:/app/media
      - logs_volume:/app/logs
    env_file:
      - .env
    depends_on:
      - db
      - redis
    networks:
      - phongtro_internal
    restart: unless-stopped

  # ============================================
  # Celery Beat (Scheduled Tasks)
  # ============================================
  celery_beat:
    build:
      context: .
      target: production
    container_name: phongtro_celery_beat
    command: celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - logs_volume:/app/logs
    env_file:
      - .env
    depends_on:
      - db
      - redis
    networks:
      - phongtro_internal
    restart: unless-stopped

  # ============================================
  # Nginx Reverse Proxy
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: phongtro_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - static_volume:/var/www/static:ro
      - media_volume:/var/www/media:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - web
    networks:
      - phongtro_internal
      - phongtro_external
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Certbot (SSL Certificate Renewal)
  # ============================================
  certbot:
    image: certbot/certbot
    container_name: phongtro_certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - phongtro_external

# ============================================
# Volumes (Persistent Data)
# ============================================
volumes:
  mssql_data:
    driver: local
  redis_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local
  logs_volume:
    driver: local

# ============================================
# Networks (Isolation)
# ============================================
networks:
  phongtro_internal:
    driver: bridge
    internal: true  # No external access
  phongtro_external:
    driver: bridge